# SPDX-License-Identifier: PMPL-1.0-or-later
# SPDX-FileCopyrightText: 2025 Axiom.jl Contributors

name: CI
permissions: read-all

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 0 * * 0'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  JULIA_NUM_THREADS: 2
  RUST_BACKTRACE: 1

jobs:
  julia-compat:
    name: Julia ${{ matrix.julia-version }} - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        julia-version: ['1.10', '1.11']
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: ${{ matrix.julia-version }}

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile / Test
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile(); Pkg.test()'

      - name: Process coverage
        if: matrix.julia-version == '1.10' && matrix.os == 'ubuntu-latest'
        uses: julia-actions/julia-processcoverage@03114f09f119417c3242a9fb6e0b722676aedf38 # v1

      - name: Upload coverage
        if: matrix.julia-version == '1.10' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          files: lcov.info
          token: ${{ secrets.CODECOV_TOKEN }}

  julia-nightly:
    name: Julia nightly - ubuntu
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: nightly

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile / Test
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile(); Pkg.test()'

  rust-build:
    name: Rust Backend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache Cargo
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            rust/target
          key: ${{ runner.os }}-cargo-${{ hashFiles('rust/Cargo.lock') }}

      - name: Check formatting
        working-directory: rust
        run: cargo fmt --check

      - name: Clippy lints
        working-directory: rust
        run: cargo clippy -- -D warnings

      - name: Run tests
        working-directory: rust
        run: cargo test

      - name: Build release
        working-directory: rust
        run: cargo build --release

  backend-parity-rust:
    name: CPU vs Rust parity + accelerated smoke
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
        with:
          toolchain: stable

      - name: Build Rust shared library
        working-directory: rust
        run: cargo build --release

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run backend parity tests
        env:
          AXIOM_RUST_LIB: ${{ github.workspace }}/rust/target/release/libaxiom_core.so
        run: julia --project=. test/ci/backend_parity.jl

      - name: Run accelerated runtime smoke test (Rust)
        env:
          AXIOM_RUST_LIB: ${{ github.workspace }}/rust/target/release/libaxiom_core.so
          AXIOM_SMOKE_ACCELERATOR: rust
          AXIOM_SMOKE_ACCELERATOR_REQUIRED: '1'
        run: julia --project=. test/ci/runtime_smoke.jl

  interop-smoke:
    name: Interop smoke (PyTorch import + ONNX export)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run interop smoke tests
        run: julia --project=. test/ci/interop_smoke.jl

  roadmap-could:
    name: Roadmap could-baselines (packaging + optimization + telemetry)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run model package + registry tests
        run: julia --project=. test/ci/model_package_registry.jl

      - name: Run optimization pass tests
        run: julia --project=. test/ci/optimization_passes.jl

      - name: Run verification telemetry tests
        run: julia --project=. test/ci/verification_telemetry.jl

      - name: Generate model package evidence
        run: julia --project=. scripts/model-package-evidence.jl

      - name: Generate optimization evidence
        run: julia --project=. scripts/optimization-evidence.jl

      - name: Generate verification telemetry evidence
        run: julia --project=. scripts/verification-telemetry-evidence.jl

      - name: Upload model package evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: model-package-evidence
          path: |
            build/model_package_evidence.json
            build/model_package
          if-no-files-found: warn

      - name: Upload optimization evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: optimization-evidence
          path: build/optimization_evidence.json
          if-no-files-found: warn

      - name: Upload verification telemetry evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: verification-telemetry-evidence
          path: build/verification_telemetry_evidence.json
          if-no-files-found: warn

  gpu-fallback:
    name: GPU fallback tests - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run fallback tests
        run: julia --project=. test/ci/gpu_fallback.jl

      - name: Run resilience diagnostics tests
        run: julia --project=. test/ci/gpu_resilience.jl

      - name: Generate GPU performance evidence (non-hardware baseline)
        env:
          AXIOM_GPU_BASELINE_BACKEND: all
          AXIOM_GPU_REQUIRED: '0'
          AXIOM_GPU_EVIDENCE_PATH: build/gpu_performance_evidence_${{ matrix.os }}.json
        run: julia --project=. scripts/gpu-performance-evidence.jl

      - name: Upload GPU performance evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gpu-performance-evidence-${{ matrix.os }}
          path: build/gpu_performance_evidence_${{ matrix.os }}.json
          if-no-files-found: warn

  coprocessor-strategy:
    name: Coprocessor strategy, resilience, and TPU/NPU/DSP/MATH strict tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run coprocessor strategy tests
        run: julia --project=. test/ci/coprocessor_strategy.jl

      - name: Generate coprocessor evidence artifact
        run: julia --project=. scripts/coprocessor-evidence.jl

      - name: Run coprocessor resilience diagnostics tests
        run: julia --project=. test/ci/coprocessor_resilience.jl

      - name: Generate coprocessor resilience evidence artifact
        run: julia --project=. scripts/coprocessor-resilience-evidence.jl

      - name: Run TPU strict mode tests
        run: julia --project=. test/ci/tpu_required_mode.jl

      - name: Generate TPU strict mode evidence artifact
        run: julia --project=. scripts/tpu-strict-evidence.jl

      - name: Run NPU strict mode tests
        run: julia --project=. test/ci/npu_required_mode.jl

      - name: Generate NPU strict mode evidence artifact
        run: julia --project=. scripts/npu-strict-evidence.jl

      - name: Run DSP strict mode tests
        run: julia --project=. test/ci/dsp_required_mode.jl

      - name: Generate DSP strict mode evidence artifact
        run: julia --project=. scripts/dsp-strict-evidence.jl

      - name: Run MATH strict mode tests
        run: julia --project=. test/ci/math_required_mode.jl

      - name: Generate MATH strict mode evidence artifact
        run: julia --project=. scripts/math-strict-evidence.jl

      - name: Upload coprocessor evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coprocessor-evidence
          path: build/coprocessor_evidence.json
          if-no-files-found: warn

      - name: Upload coprocessor resilience evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: coprocessor-resilience-evidence
          path: build/coprocessor_resilience_evidence.json
          if-no-files-found: warn

      - name: Upload TPU strict mode evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: tpu-strict-evidence
          path: build/tpu_strict_evidence.json
          if-no-files-found: warn

      - name: Upload NPU strict mode evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: npu-strict-evidence
          path: build/npu_strict_evidence.json
          if-no-files-found: warn

      - name: Upload DSP strict mode evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dsp-strict-evidence
          path: build/dsp_strict_evidence.json
          if-no-files-found: warn

      - name: Upload MATH strict mode evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: math-strict-evidence
          path: build/math_strict_evidence.json
          if-no-files-found: warn

  gpu-cuda-hardware:
    name: GPU hardware smoke (CUDA)
    if: ${{ vars.AXIOM_ENABLE_GPU_HARDWARE_CI == 'true' }}
    runs-on: [self-hosted, linux, x64, gpu, cuda]

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run CUDA smoke tests
        env:
          AXIOM_GPU_BACKEND: cuda
          AXIOM_GPU_REQUIRED: '1'
        run: julia --project=. test/ci/gpu_hardware_smoke.jl

      - name: Generate CUDA performance evidence
        env:
          AXIOM_GPU_BACKEND: cuda
          AXIOM_GPU_BASELINE_BACKEND: cuda
          AXIOM_GPU_REQUIRED: '1'
          AXIOM_GPU_BASELINE_ENFORCE: '0'
          AXIOM_GPU_EVIDENCE_PATH: build/gpu_performance_cuda.json
        run: julia --project=. scripts/gpu-performance-evidence.jl

      - name: Upload CUDA performance evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gpu-performance-evidence-cuda
          path: build/gpu_performance_cuda.json
          if-no-files-found: warn

  gpu-rocm-hardware:
    name: GPU hardware smoke (ROCm)
    if: ${{ vars.AXIOM_ENABLE_GPU_HARDWARE_CI == 'true' }}
    runs-on: [self-hosted, linux, x64, gpu, rocm]

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run ROCm smoke tests
        env:
          AXIOM_GPU_BACKEND: rocm
          AXIOM_GPU_REQUIRED: '1'
        run: julia --project=. test/ci/gpu_hardware_smoke.jl

      - name: Generate ROCm performance evidence
        env:
          AXIOM_GPU_BACKEND: rocm
          AXIOM_GPU_BASELINE_BACKEND: rocm
          AXIOM_GPU_REQUIRED: '1'
          AXIOM_GPU_BASELINE_ENFORCE: '0'
          AXIOM_GPU_EVIDENCE_PATH: build/gpu_performance_rocm.json
        run: julia --project=. scripts/gpu-performance-evidence.jl

      - name: Upload ROCm performance evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gpu-performance-evidence-rocm
          path: build/gpu_performance_rocm.json
          if-no-files-found: warn

  gpu-metal-hardware:
    name: GPU hardware smoke (Metal)
    if: ${{ vars.AXIOM_ENABLE_GPU_HARDWARE_CI == 'true' }}
    runs-on: [self-hosted, macOS, ARM64, gpu, metal]

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run Metal smoke tests
        env:
          AXIOM_GPU_BACKEND: metal
          AXIOM_GPU_REQUIRED: '1'
        run: julia --project=. test/ci/gpu_hardware_smoke.jl

      - name: Generate Metal performance evidence
        env:
          AXIOM_GPU_BACKEND: metal
          AXIOM_GPU_BASELINE_BACKEND: metal
          AXIOM_GPU_REQUIRED: '1'
          AXIOM_GPU_BASELINE_ENFORCE: '0'
          AXIOM_GPU_EVIDENCE_PATH: build/gpu_performance_metal.json
        run: julia --project=. scripts/gpu-performance-evidence.jl

      - name: Upload Metal performance evidence
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: gpu-performance-evidence-metal
          path: build/gpu_performance_metal.json
          if-no-files-found: warn

  runtime-smoke-cpu:
    name: Runtime smoke (CPU)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run runtime smoke test (CPU)
        run: julia --project=. test/ci/runtime_smoke.jl

  certificate-integrity:
    name: Certificate integrity checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run certificate integrity tests
        run: julia --project=. test/ci/certificate_integrity.jl

  proof-assistant-bundle:
    name: Proof assistant bundle checks
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - uses: julia-actions/setup-julia@5c9647d97b78a5debe5164e9eec09d653d29bd71 # v2
        with:
          version: '1.10'

      - uses: julia-actions/cache@e8472695fb3c2028b1118dc399c8440ff497d409 # v2

      - name: Instantiate / Build / Precompile
        run: julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.build(); Pkg.precompile()'

      - name: Run proof bundle reconciliation test
        run: julia --project=. test/ci/proof_bundle_reconciliation.jl

      - name: Generate proof bundle evidence artifact
        run: julia --project=. scripts/proof-bundle-evidence.jl

      - name: Upload proof bundle evidence artifact
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: proof-bundle-evidence
          path: build/proof_bundle_evidence.json
          if-no-files-found: warn

  zig-build:
    name: Zig Backend
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@abea47f85e598557f500fa1fd2ab7464fcb39406 # v2
        with:
          version: 0.13.0

      - name: Check formatting
        working-directory: zig
        run: zig fmt --check src/

      - name: Run tests
        working-directory: zig
        run: zig build test

      - name: Build release
        working-directory: zig
        run: zig build -Doptimize=ReleaseFast

  docs-sanity:
    name: Documentation sanity
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Check core docs exist
        run: |
          test -f README.adoc
          test -f ROADMAP.adoc
          test -f docs/wiki/Home.md
          test -f docs/wiki/User-Guide.md
          test -f docs/wiki/Developer-Guide.md
          test -f docs/wiki/Roadmap-Commitments.md

  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Rust dependency audit
        working-directory: rust
        run: cargo audit

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@6961f2bace57ab32b23b3ba40f8f420f6bc7e004 # v3.93.3
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          extra_args: --only-verified
